<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Añadir Tarea</title>
</head>
<body>
    <button onclick="changeToTasks()">Volver a las tareas de la lista</button>
    <h1 id="listID">{{.ListID}}</h1>


    <label for="taskName">Nombre de la tarea</label>
    <input type="text" id="taskName" name="taskName"><br><br>
    <label for="description">Descripcion de la tarea</label>
    <input type="text" id="description" name="description"><br><br>
    <label for="state">Estado de la tarea</label>
    <select name="state" id="state">
        <option value="Por hacer">Por hacer</option>
        <option value="En progreso">En progreso</option>
        <option value="Hecho">Hecho</option>
    </select>
    
    <label for="date">Fecha de la tarea</label>
    <input type="date" id="date" name="date"><br><br>

    <select name="usuarios" id="usuarios" multiple>
        {{range .ListUsers}}
        <option value={{.}}>{{.}}</option>
        {{end}}
    </select>

    <input type="file" id="subir_archivo"/>

    <button onclick="addTask()">Añadir Tarea</button>

    <button onclick="leerArchivo()">Adjuntar archivo</button>

    
    <div id="archivosAdjuntos">
        <h3>Archivos adjuntos</h3>
    </div>

</body>
</html>
<script>



    function changeToTasks(){
        let listID = document.querySelector('#listID').textContent
        changeToTasksGO(listID).then(
            function(){
            }
        )
    }



    let extensionAllow = ['jpg', 'jpeg', 'png', 'pdf', 'txt'];

    function leerArchivo(){
        let elemento = document.querySelector('#subir_archivo');
        if (elemento.files.length > 0){
            let nombreArchivo = elemento.files[0].name
            let extension = elemento.files[0].name.split('.').pop().toLowerCase()
            if (extensionAllow.indexOf(extension) > -1){
                if(elemento.files.length != 0){
                    var file = elemento.files[0];
                    var reader = new FileReader();
                    reader.onloadend = function() {
                        let divPadre = document.querySelector('#archivosAdjuntos');
                        datosArchivo = reader.result
                        let a = document.createElement('a')
                        a.textContent = nombreArchivo
                        a.href = datosArchivo
                        a.download = nombreArchivo
                        let button = document.createElement('button');
                        button.innerHTML = "Eliminar archivo";
                        button.onclick = function () {deleteFileTask(event)};
                        let div = document.createElement('div');
                        div.appendChild(a)
                        div.appendChild(button)
                        divPadre.appendChild(div)

                        elemento.value = ""
                    }
                reader.readAsDataURL(file);
                }
            }else{
                alert('Extension no permitida')
                elemento.value = ""
            }
        }else{
            alert('Añade un archivo para adjuntarlo')
        }
    }


    function deleteFileTask(event){
        var div = event.target.closest('div');
        div.remove()
    }


    function addTask(){

        //Archivos
        let archivosDiv = document.querySelector('#archivosAdjuntos').querySelectorAll('a');
        let archivos = []
        if (archivosDiv.length > 0) {
            for (let index = 0; index < archivosDiv.length; index++) {
                nombre = archivosDiv[index].textContent;
                datos = archivosDiv[index].href;
                let archivo = {
                    "FileName" : nombre,
                    "FileData" : datos,
                }
                archivos.push(archivo)
            } 
        }
       
        let listID = document.querySelector('#listID').textContent
        let date = document.querySelector('#date').value
        let taskName = document.querySelector('#taskName').value
        let description = document.querySelector('#description').value
        let state = document.querySelector('#state').value
        let users = document.querySelector('#usuarios').selectedOptions
        let usersNames = []
        for (let index = 0; index < users.length; index++) {
            usersNames.push(users[index].value)
        }
        let task = {
            "Name" : taskName,
            "Description" : description,
            "Date" : date,
            "State" : state,
            "Users" : usersNames,
            "Files" : archivos
        }
        addTaskGO(listID, task, date).then(
            function(resultado){
                if (resultado){
                    alert('La tarea se creo')
                    changeToTasks(listID)
                }else{
                    alert('La tarea no se creo')
                }
            }
        )
    }

</script>