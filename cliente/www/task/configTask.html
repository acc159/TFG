<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarea</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <style>
        .recepciones{
            margin-top: 10px;
        }

        nav{
            height: 55px;
        }
        .button_nav{
            border-color: f8f9fa;
            color: f8f9fa;
            margin-right: 3px;
        }
        #buttonNav1, #buttonNav2, #buttonNav3, #buttonNav4{
            border-width: 0px;
            color: f8f9fa;
        }
        #buttonNav1:hover, #buttonNav2:hover, #buttonNav3:hover, #buttonNav4:hover{
            color: rgba(0,0,0,.7);
        }

        .btn-link{
            color: black;
            text-decoration: none;
        }
        
        .btn-link:hover{
            color: #4f5670;
            text-decoration: none;
        }
        .btn-link:focus{
            text-decoration: none;
        }
        .card-header:hover, .card-header:focus, .card-header button .collapse:active, .card-header button .collapse:hover, .card-header button .collapse:target{
            background-color: #e5e4e4;
        }

    </style>

</head>
<body>
    <h1 hidden id="listName">{{.List.Name}}</h1>
    <h1 id="listID" hidden>{{.List.ID}}</h1>
    <h1 id="taskID" hidden>{{.Task.ID}}</h1>
    <h1 id="taskCheck" hidden>{{.Task.Check}}</h1>
    <h1 id="user" hidden>{{.User}}</h1>

    <nav class="navbar navbar-light bg-dark">
        <form class="form-inline">
            <li class="nav-item btn-outline-light" type="button">
                <a class="button_nav nav-link btn btn-outline-light" role="button" onclick="changeHome()">HOME</a>
            </li>
            <li class="nav-item btn-outline-light" type="button">
                <a id="buttonNav1" class="button_nav nav-link btn btn-outline-light" role="button" onclick="changeToTasks()">Ver Tareas de la lista</a>
            </li>
            <li class="nav-item btn-outline-light" type="button">
                <a id="buttonNav2" class="button_nav nav-link btn btn-outline-light" role="button" onclick="UpdateTask()">Actualizar Tarea</a>
            </li>
            <li class="nav-item btn-outline-light" type="button">
                <a id="buttonNav3" class="button_nav nav-link btn btn-outline-light" role="button" onclick="changeToTaskConfig('{{.Task.ID}}', '{{.List.ID}}')">Refrescar Tarea</a>
            </li>
            <li class="nav-item btn-outline-light" type="button">
                <a id="buttonNav4" class="button_nav nav-link btn btn-outline-light" role="button" onclick="DeleteTask()">Borrar Tarea</a>
            </li>
        </form>
    </nav>

    <!-- <nav class="navbar navbar-light bg-light">
        <form class="form-inline">
            <a class="nav-link btn-outline-secondary" type="button" role="button" onclick="changeHome(false)">Volver al Home</a>
            <a class="nav-link btn-outline-info" type="button" role="button" onclick="changeToTasks()">Ver Tareas de la lista</a>
            <a class="nav-link btn-outline-info" type="button" role="button" onclick="UpdateTask()">Actualizar Tarea</a>
            <a class="nav-link btn-outline-info" type="button" role="button" onclick="changeToTaskConfig('{{.Task.ID}}', '{{.List.ID}}')">Refrescar Tarea</a>
            <a class="nav-link btn-outline-info" type="button" role="button" onclick="DeleteTask()">Borrar Tarea</a>
        </form>
    </nav> -->
    
    {{$user:=.User}}
    <div class="container">
        <div class="text-center">
            <h1 class="display-4">Editar</h1>
        </div>
        <div>
            <div id="accordion">
                <!-- Datos -->
                <div class="card">
                  <div class="card-header text-center" id="headingOne">
                    <h5 class="mb-0">
                      <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        <h2 class="display-4">Datos</h2>
                      </button>
                    </h5>
                  </div>
                  <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <form id="formDatos">
                            <div class="form-group">
                                <label for="taskName">Nombre de la tarea</label>
                                <input placeholder="Nombre" class="form-control" type="text" id="taskName" name="taskName" value="{{.Task.Name}}">
                                <label for="description">Descripcion de la tarea</label>
                                <textarea placeholder="Descripción" class="form-control" name="description" id="description" cols="10" rows="3">{{.Task.Description}}</textarea>
                                <label for="date">Fecha de la tarea</label>
                                <input class="form-control" placeholder="Fecha" type="date" id="date" name="date" value="{{.Task.Date}}">


                                <div class="form-row">
                                    <div class="col">
                                        <label for="state">Estado:</label>
                                        <select class="form-control" name="state" id="state">
                                        {{if eq .Task.State "Pendiente"}}
                                            <option selected value="Pendiente">Pendiente</option>
                                            <option value="En Proceso">En Proceso</option>
                                            <option value="Finalizada">Finalizada</option>
                                        {{end}}
                                        {{if eq .Task.State "En Proceso"}}
                                            <option value="Pendiente">Pendiente</option>
                                            <option selected value="En Proceso">En Proceso</option>
                                            <option value="Finalizada">Finalizada</option>
                                        {{end}}
                                        {{if eq .Task.State "Finalizada"}}
                                            <option disabled read-only selected value="Finalizada">Finalizada</option>
                                        {{end}}                    
                                        </select>
                                    </div>
                                    <div class="col">
                                        <label for="state">Progreso: <span type="text" id="textInputProgress" value="">{{.Task.Progress}}</span></label>
                                        <input class="form-range form-control" value="{{.Task.Progress}}" type="range" name="rangeInput" min="0" max="100" onchange="updateTextInput(this.value);">
                                    </div>
                                  </div>
                                <label for="creator">Creada por:</label>
                                <input class="form-control" id="creator" type="text" value="{{.Task.Creator}}" disabled readonly>
                            </div>
                        </form>
                    </div>
                  </div>
                </div>

                <!-- USUARIOS -->
                <div class="card">
                    <div class="card-header text-center" id="headingTwo">
                      <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            <h2 class="display-4">Usuarios</h2>
                        </button>
                      </h5>
                    </div>
                    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                      <div class="card-body">
                        <div class="row"> 
                            <div class="col border-right">
                                <div class="d-flex mb-3 justify-content-between">
                                    <h4 class="">
                                        <span class="text-muted">Usuarios Asignados</span>
                                        <span id="numUsersTask" class="badge badge-secondary badge-pill">{{len .Task.Users}}</span>
                                    </h4>
                                </div>
                                <div id="usersTask">    
                                    <ul class="list-group">
                                        {{range .Task.Users}}
                                        <li id="{{.}}" class="list-group-item d-flex justify-content-between align-items-center">
                                            {{.}}
                                            <span onclick="deleteUserTask(event)" role="button" class="badge badge-danger badge-pill" type="button">X</span>
                                        </li>
                                        {{end}}
                                    </ul>
                                </div>
                              </div>
                              <div class="col">
                                <div class="d-flex mb-3 justify-content-between">
                                    <h4 class="">
                                        <span class="text-muted">Usuarios de la Lista</span>
                                    </h4>
                                    <div>
                                        <button class="test btn btn-primary" onclick="addUserTask()">Adjuntar</button>
                                    </div>
                                </div>
                                <select class="form-control" name="usersList" id="usersList" multiple>
                                    {{range .List.Users}}
                                        <option value={{.User}}>{{.User}}</option>
                                    {{end}}
                                </select>
                              </div>
                        </div>
                      </div>
                    </div>
                </div>

                <!-- Adjuntos -->
                <div class="card">
                    <div class="card-header text-center" id="headingThree">
                      <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            <h2 class="display-4">Adjuntos</h2>
                        </button>
                      </h5>
                    </div>
                    <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
                      <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 order-md-1">
                                <div class="d-flex mb-3 justify-content-between">
                                    <h4 class="">
                                        <span class="text-muted">Archivos Adjuntos</span>
                                        <span id="numArchivos" class="badge badge-secondary badge-pill">{{len .Task.Files}}</span>
                                    </h4>
                                    <div>
                                        <button class="btn btn-primary" onclick="leerArchivo()">Adjuntar</button>
                                    </div>
                                </div>
                                <ul id="archivosAdjuntos" class="list-group mb-3">
                                    {{range .Task.Files}}
                                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                                            <div class="container row">
                                                <div class="col-md-6 order-md-1">
                                                    <a href="{{.FileData}}" target="_blank" class="file" download="{{.FileName}}" data-user="{{.UserFile}}" data-userSign="{{.SignData.UserSign}}">{{.FileName}}</a>
                                                </div>
                                                <div class="col-md-3 order-md-2">
                                                    {{if eq $user .UserFile}}
                                                        <a class="text-muted" type="button" role="button" onclick="deleteFile(event)">Eliminar</a>
                                                    {{end}}
                                                </div>
                                                <div class="col-md-3 order-md-3">
                                                    {{if .SignData.Sign}}
                                                        <a data-type="file" class="text-muted" type="button" role="button" onclick="verifySignDataTask(event)">Verificar Firma</a>
                                                    {{else}}
                                                        {{if eq $user .UserFile}}
                                                            <a class="text-muted" type="button" role="button" onclick="signFile(event)">Firmar</a>
                                                        {{else}}
                                                            <a class="text-muted">Sin firmar</a>
                                                        {{end}}
                                                    {{end}}
                                                </div>
                                            </div>
                                        </li>
                                    {{end}}
                                </ul>
                                <form class="card p-2">
                                    <div class="input-group row">
                                        <input type="file" id="subir_archivo" class="col-md-12 order-md-1">                       
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-12 order-md-2 mb-4">
                                <div class="d-flex mb-3 justify-content-between">
                                    <h4 class="">
                                        <span class="text-muted">Enlaces Adjuntos</span>
                                        <span id="numUrls" class="badge badge-secondary badge-pill">{{len .Task.Links}}</span>
                                    </h4>
                                    <div>
                                        <button class="btn btn-primary" onclick="AddLink()">Adjuntar</button>
                                    </div>
                                </div>
                                <ul id="enlacesAdjuntos" class="list-group mb-3">
                                    {{range .Task.Links}}
                                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                                            <div class="container row">
                                                <div class="col-md-6 order-md-1">
                                                    <a class="url" target="_blank" href="{{.LinkUrl}}" data-user="{{.UserLink}}" data-userSign="{{.SignData.UserSign}}">{{.LinkName}}</a>
                                                </div>
                                                <div class="col-md-3 order-md-2">
                                                    {{if eq $user .UserLink}}
                                                        <a class="text-muted" type="button" role="button" onclick="deleteUrl(event)">Eliminar</a>
                                                    {{end}}
                                                </div>
                                                <div class="col-md-3 order-md-3">
                                                    {{if .SignData.Sign}}
                                                        <a data-type="link" class="text-muted" type="button" role="button" onclick="verifySignDataTask(event)">Verificar Firma</a>
                                                    {{else}}
                                                        {{if eq $user .UserLink}}
                                                            <a class="text-muted" type="button" role="button" onclick="signUrl(event)">Firmar</a>
                                                        {{else}}
                                                            <a class="text-muted">Sin firmar</a>
                                                        {{end}}
                                                    {{end}}
                                                </div>
                                            </div>
                                        </li>
                                    {{end}}
                                </ul>
                                <form class="card p-2">
                                    <div class="input-group">
                                        <input class="col-md-6 order-md-1 form-control" type="url" name="link" id="link" placeholder="Url">
                                        <input class="col-md-6 order-md-2 form-control" type="text" name="linkName" id="linkName" placeholder="Nombre Url">
                                    </div>
                                </form>
                            </div>
                        </div>
                      </div>
                    </div>
                </div>

                <!-- EVENTOS  -->
                <div class="card">
                    <div class="card-header text-center" id="headingTwo">
                      <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            <h2 class="display-4">Registro de Eventos</h2>
                        </button>
                      </h5>
                    </div>
                    <div id="collapseFour" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                      <div class="card-body">
                        <!-- Creacion -->
                        <div class="row">
                        <div class="col-md-12 order-md-1 border-bottom">
                            <div class="d-flex mb-3 justify-content-between">
                                <h4 class="">
                                    <span class="text-muted">Confirmacion de creación</span>
                                </h4>
                                <div>
                                    {{if eq .Task.SignCreator.Sign ""}}
                                        {{if (call .CheckCreator .Task)}}
                                            <button class="btn btn-primary" onclick="signEventTask(event, 'Creacion')">Firmar creación de la tarea</button>
                                        {{end}}
                                    {{end}}
                                </div>
                            </div>
                            <ul id="creacion" class="list-group mb-3">
                                {{if ne .Task.SignCreator.Sign ""}}
                                    <li class="list-group-item d-flex justify-content-between lh-condensed">
                                        <div class="container row">
                                            <div class="col-md-11 order-md-1">
                                                <a data-usersign="{{.Task.SignCreator.UserSign}}">{{.Task.SignCreator.Message}}</a>
                                            </div>
                                            <div class="col-md-1 order-md-2">
                                                <button class="btn btn-outline-info" onclick="verifySignEvent(event, 'Creacion')">Verificar</button>
                                            </div>
                                        </div>
                                    </li>
                                {{end}}
                            </ul>
                        </div>
                    </div>

                    <!-- Recepciones -->
                    <div class="row">
                        <div class="col-md-12 order-md-1 border-bottom recepciones">
                            <div class="d-flex mb-3 justify-content-between">
                                <h4 class="">
                                    <span class="text-muted">Confirmaciones de Recepción</span>
                                </h4>
                                <div>
                                    {{if (call .IsUserAssigned .Task)}}
                                        {{if not (call .HasSignReceivedByUser .Task)}}
                                            <button class="btn btn-primary" onclick="signEventTask(event, 'Recepcion')">Firmar Recepción de la tarea</button>
                                        {{end}}
                                    {{end}}
                                </div>
                            </div>
                            <ul id="recepciones" class="list-group mb-3">
                                {{range .Task.SignsReceived}}
                                <li class="list-group-item d-flex justify-content-between lh-condensed">
                                    <div class="container row">
                                        <div class="col-md-11 order-md-1">
                                            <a data-usersign="{{.UserSign}}">{{.Message}}</a>
                                        </div>
                                        <div class="col-md-1 order-md-2">
                                            <button class="btn btn-outline-info" onclick="verifySignEvent(event, 'Recepcion')">Verificar</button>
                                        </div>
                                    </div>
                                </li>
                                {{end}}
                            </ul>
                        </div>
                    </div>

                    <!-- Finalizacion -->
                        <div class="row">
                            <div class="col-md-12 order-md-1 border-bottom recepciones">
                                <div class="d-flex mb-3 justify-content-between">
                                    <h4 class="">
                                        <span class="text-muted">Confirmaciones de Finalización</span>
                                    </h4>
                                    <div>
                                        {{if eq .Task.State "Finalizada"}}
                                            {{if (call .IsUserAssigned .Task)}}
                                                {{if not (call .HasSignCloseByUser .Task)}}
                                                    <button class="btn btn-primary" onclick="signEventTask(event, 'Finalizacion')">Firmar Finalización de la tarea</button>
                                                {{end}}
                                            {{end}}    
                                        {{end}}
                                    </div>
                                </div>
                                <ul id="finalizaciones" class="list-group mb-3">
                                    {{range .Task.SignsClose}}
                                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                                            <div class="container row">
                                                <div class="col-md-11 order-md-1">
                                                    <a data-usersign="{{.UserSign}}">{{.Message}}</a>
                                                </div>
                                                <div class="col-md-1 order-md-2">
                                                    <button class="btn btn-outline-info" onclick="verifySignEvent(event, 'Finalizacion')">Verificar</button>
                                                </div>
                                            </div>
                                        </li>
                                    {{end}}
                                </ul>
                            </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div class="modal" id="myModal2" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Cambios sin guardar</h4>
              <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
              Hay cambios sin actualizar, sube tus cambios al servidor antes de salir
            </div>
            <div class="modal-footer">
                <button type="button" onclick="UpdateTask()" class="btn btn-info">Actualizar</button>
                <button type="button" onclick="changeHome(true)" class="btn btn-danger" data-dismiss="modal">Salir sin actualizar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal" id="myModal3" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Cambios sin guardar</h4>
              <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
              Hay cambios sin actualizar, sube tus cambios al servidor antes de salir
            </div>
            <div class="modal-footer">
                <button type="button" onclick="UpdateTask()" class="btn btn-info">Actualizar</button>
                <button type="button" onclick="changeToTasks(true)" class="btn btn-danger" data-dismiss="modal">Salir sin actualizar</button>
            </div>
          </div>
        </div>
      </div>

</body>
</html>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script>
//Actualiza el valor del range que indica el porcentaje de progreso de una tarea
function updateTextInput(val) {
    document.getElementById('textInputProgress').textContent=val;
    if (val == '0'){
        document.querySelector('#state').value = "Pendiente"
    } else if (val == '100'){
        document.querySelector('#state').value = "Finalizada"
    }
}

let changes = false

$("#formDatos").change(function() {
    changes = true
});

$('div .card-body').on('DOMSubtreeModified', function(){
    changes = true
});

let extensionAllow = ['jpg', 'jpeg', 'png', 'pdf', 'txt'];

function leerArchivo(){
    let elemento = document.querySelector('#subir_archivo');
    if (elemento.files.length > 0){
        let nombreArchivo = elemento.files[0].name
        let extension = elemento.files[0].name.split('.').pop().toLowerCase()
        if (extensionAllow.indexOf(extension) > -1){
            if (CheckFileName(nombreArchivo)){
                if(elemento.files.length != 0){
                    var file = elemento.files[0];
                    var reader = new FileReader();
                    reader.onloadend = function() {
                        datosArchivo = reader.result
                        AddFile(datosArchivo, nombreArchivo)
                        elemento.value = ""
                        let numeroFiles = document.querySelector('#numArchivos').textContent 
                        numeroFiles = parseInt(numeroFiles)
                        numeroFiles++
                        document.querySelector('#numArchivos').textContent = numeroFiles
                    }
                    reader.readAsDataURL(file);
                }
            }else{
                alert('El fichero ' + nombreArchivo + ' ya a sido adjuntado')
            }
        }else{
            alert('Extension no permitida')
            elemento.value = ""
        }
    }else{
        alert('Añade un archivo para adjuntarlo')
    }
}


    function AddLink(){
        let link = document.querySelector('#link').value;
        let linkName = document.querySelector('#linkName').value;
        if (link != "" && linkName != "")
        {
            AddUrl(link, linkName)
            let numUrls = document.querySelector('#numUrls').textContent 
            numUrls = parseInt(numUrls)
            numUrls++
            document.querySelector('#numUrls').textContent = numUrls;
            document.querySelector('#link').value = "";
            document.querySelector('#linkName').value = "";
        }else{
            alert('Introduce un enlace para añadirlo');
        }
    }


    function deleteFile(event){
        li = event.target.closest('li')
        li.remove()
        let numeroFiles = document.querySelector('#numArchivos').textContent 
        numeroFiles = parseInt(numeroFiles)
        numeroFiles--
        document.querySelector('#numArchivos').textContent = numeroFiles
    }

    function CheckFileName(nombreArchivo){
        let archivosDiv = document.querySelector('#archivosAdjuntos').querySelectorAll('.file');
        if (archivosDiv.length > 0) {
            for (let index = 0; index < archivosDiv.length; index++) {
                nombre = archivosDiv[index].textContent;
                if (nombre == nombreArchivo){
                    return false
                }
            } 
        }
        return true
    }


    function AddFile(datosArchivo, nombreArchivo){
        let ulPadre = document.querySelector('#archivosAdjuntos');
        let li = document.createElement('li')
        li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'lh-condensed')
        let divPadre = document.createElement('div')   
        divPadre.classList.add('container', 'row')   
        //Creamos los tres divs
        let divFile = document.createElement('div')  
        divFile.classList.add('col-md-6', 'order-md-1')        
        let divDelete = document.createElement('div')
        divDelete.classList.add('col-md-3', 'order-md-2')           
        let divSign = document.createElement('div')  
        divSign.classList.add('col-md-3', 'order-md-3') 
        let aFile = document.createElement('a')
        aFile.setAttribute('target', '_blank');
        aFile.classList.add('file')
        aFile.dataset.sign = ""
        aFile.dataset.usersign = ""
        aFile.dataset.user = document.querySelector('#user').textContent
        aFile.textContent = nombreArchivo
        aFile.href = datosArchivo
        aFile.download = nombreArchivo
        divFile.appendChild(aFile)
        let aDelete = document.createElement('a')
        aDelete.onclick = function () {deleteFile(event)};
        aDelete.textContent = "Eliminar"
        aDelete.classList.add('text-muted')
        aDelete.setAttribute("type", "button")
        aDelete.setAttribute("role", "button")
        divDelete.appendChild(aDelete)
        let aSign = document.createElement('a')
        aSign.onclick = function () {signFile(event)};
        aSign.textContent = "Firmar"
        aSign.classList.add('text-muted')
        aSign.setAttribute("type", "button")
        aSign.setAttribute("role", "button")
        divSign.appendChild(aSign)
        divPadre.appendChild(divFile)
        divPadre.appendChild(divDelete)
        divPadre.appendChild(divSign)
        li.appendChild(divPadre)
        ulPadre.appendChild(li)
    }






    function deleteUrl(event){
        li = event.target.closest('li')
        li.remove()
        let numUrls = document.querySelector('#numUrls').textContent 
        numUrls = parseInt(numUrls)
        numUrls--
        document.querySelector('#numUrls').textContent = numUrls
    }

    function AddUrl(datosArchivo, nombreArchivo){
        let ulPadre = document.querySelector('#enlacesAdjuntos');
        let li = document.createElement('li')
        li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'lh-condensed')
        let divPadre = document.createElement('div')   
        divPadre.classList.add('container', 'row')   
        //Creamos los tres divs
        let divFile = document.createElement('div')  
        divFile.classList.add('col-md-6', 'order-md-1')        
        let divDelete = document.createElement('div')
        divDelete.classList.add('col-md-3', 'order-md-2')           
        let divSign = document.createElement('div')  
        divSign.classList.add('col-md-3', 'order-md-3') 
        let aFile = document.createElement('a')
        aFile.dataset.user = document.querySelector('#user').textContent
        aFile.dataset.sign = ""
        aFile.dataset.usersign = ""
        aFile.setAttribute('target', '_blank');
        aFile.classList.add('url')
        aFile.textContent = nombreArchivo
        aFile.href = datosArchivo
        aFile.download = nombreArchivo
        divFile.appendChild(aFile)
        let aDelete = document.createElement('a')
        aDelete.onclick = function () {deleteUrl(event)};
        aDelete.textContent = "Eliminar"
        aDelete.classList.add('text-muted')
        aDelete.setAttribute("type", "button")
        aDelete.setAttribute("role", "button")
        divDelete.appendChild(aDelete)
        let aSign = document.createElement('a')
        aSign.onclick = function () {signUrl(event)};
        aSign.textContent = "Firmar"
        aSign.classList.add('text-muted')
        aSign.setAttribute("type", "button")
        aSign.setAttribute("role", "button")
        divSign.appendChild(aSign)
        divPadre.appendChild(divFile)
        divPadre.appendChild(divDelete)
        divPadre.appendChild(divSign)
        li.appendChild(divPadre)
        ulPadre.appendChild(li)
    }


    function signUrl(event){
        li = event.target.closest('li')
        let fileData = li.querySelector('div').querySelector('div').querySelector('a').href 
        signGO(fileData).then(
            function(signHash){
                li.querySelector('.url').dataset.sign = signHash 
                li.querySelector('.url').dataset.usersign = document.querySelector('#user').textContent 
                let span = document.createElement('span')
                span.textContent = " Firmado"
                span.classList.add('badge', 'badge-secondary' , 'firmado')
                li.querySelector('div').querySelector('div').appendChild(span)
                li.querySelector('div').querySelectorAll('div')[2].querySelector('a').remove()
            }
        )
    }


    function signFile(event){
        li = event.target.closest('li')
        let fileData = li.querySelector('div').querySelector('div').querySelector('a').href 
        signGO(fileData).then(
            function(signHash){
                li.querySelector('.file').dataset.sign = signHash 
                li.querySelector('.file').dataset.usersign = document.querySelector('#user').textContent 
                let span = document.createElement('span')
                span.textContent = " Firmado"
                span.classList.add('badge', 'badge-secondary' , 'firmado')
                li.querySelector('div').querySelector('div').appendChild(span)
                li.querySelector('div').querySelectorAll('div')[2].querySelector('a').remove()
            }
        )
    }


    function changeToTasks(exit){
        if (changes == false || exit){
            let listID = document.querySelector('#listID').textContent
            let listName = document.querySelector('#listName').textContent
            changeToTasksGO(listID , listName).then(
                function(resultados){
                    let tokenExpire = resultados[1];
                    let changeOK = resultados[0];
                    if (tokenExpire){
                        alert('El Token de la sesión expiro')
                        exitSesion();
                    }else{
                        if (changeOK == false){
                            alert('La lista ya no existe')
                            changeHome(true)
                        }
                    }
                })
        }else{
            $('#myModal3').modal('show')
        }
    }

    function deleteUserTask(){
        var li = event.target.closest('li');
        let option = document.createElement('option');
        option.value = li.id;
        option.textContent= li.id;
        document.querySelector('#usersList').appendChild(option);
        li.remove();

        let numUsers  = document.querySelector('#numUsersTask').textContent;
        let numero = parseInt(numUsers);
        numero--;
        document.querySelector('#numUsersTask').textContent = numero;

    }

    function addUserTask(){
       let selectedUsers = document.querySelector('#usersList').selectedOptions;
       let selectedUsersNum = selectedUsers.length;
       if (selectedUsers.length > 0){
            let usersNames = []
            for (let index = selectedUsers.length; index > 0; index--) {
                    usersNames.push(selectedUsers[index - 1].value)
                    selectedUsers[index - 1].remove();
            }
            //Ahora los meto en la lista de usuarios de la tarea
            let usersTask = document.querySelector('#usersTask').querySelector('ul');
            for (let i = 0; i < usersNames.length; i++) {
                let li = document.createElement('li');
                li.id = usersNames[i];
                li.textContent = usersNames[i];
                li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center')
                span = document.createElement('span');
                span.textContent = "X"
                span.classList.add('badge', 'badge-danger', 'badge-pill')
                span.setAttribute('type',"button")
                span.onclick = function () {deleteUserTask(event)};
                li.appendChild(span)
                usersTask.appendChild(li)
            }
            let numUsers  = document.querySelector('#numUsersTask').textContent;
            let numero = parseInt(numUsers);
            numero += selectedUsersNum;
            document.querySelector('#numUsersTask').textContent = numero;
       }else{
           alert('Marca algun usuario para añadirlo asignarlo a la tarea')
       }
    }

    function GetFiles(){
        let archivos = []
        let archivosDiv = document.querySelector('#archivosAdjuntos').querySelectorAll('.file');
            if (archivosDiv.length > 0) {
                for (let index = 0; index < archivosDiv.length; index++) {
                    nombre = archivosDiv[index].textContent;
                    datos = archivosDiv[index].href;
                    sign = archivosDiv[index].dataset.sign;
                    signUser = archivosDiv[index].dataset.usersign;
                    userFile = archivosDiv[index].dataset.user;
                    let archivo = {
                        "FileName" : nombre,
                        "FileData" : datos,
                        "UserFile" : userFile,
                        "SignData" : {
                            "Sign": sign,
                            "UserSign": signUser
                        },
                    }
                    archivos.push(archivo)
                } 
            }
        return archivos
    }


    function GetLinks(){
        let user = document.querySelector('#user').textContent
        let TaskLinks = []
        let links = document.querySelector('#enlacesAdjuntos').querySelectorAll('.url');
        for (let i = 0; i < links.length; i++) {
            let LinkStruct = {
                "LinkName" : links[i].textContent,
                "LinkUrl" : links[i].getAttribute('href'),
                "UserLink" : links[i].dataset.user,
                "SignData" : {
                        "Sign": links[i].dataset.sign,
                        "UserSign": links[i].dataset.usersign
                    },
            }
            TaskLinks.push(LinkStruct)
        }
        return TaskLinks
    }


    function GetSignReceived(){
        let user = document.querySelector('#user').textContent
        let ReceivedList = []
        let confirms = document.querySelector('#recepciones').querySelectorAll('a')
        for (let i = 0; i < confirms.length; i++) {
            let ReceivedStruct = {
                "Sign" : confirms[i].dataset.sign,
                "UserSign" : confirms[i].dataset.usersign,
                "Message": confirms[i].textContent,
            }
            ReceivedList.push(ReceivedStruct)
        }
        return ReceivedList
    }

    function GetSignClose(){
        let user = document.querySelector('#user').textContent
        let ReceivedList = []
        let confirms = document.querySelector('#finalizaciones').querySelectorAll('a')
        for (let i = 0; i < confirms.length; i++) {
            let ReceivedStruct = {
                "Sign" : confirms[i].dataset.sign,
                "UserSign" : confirms[i].dataset.usersign,
                "Message": confirms[i].textContent,
            }
            ReceivedList.push(ReceivedStruct)
        }
        return ReceivedList
    }

    function GetSignCreator(){
        let creator 
        let creatorSign = document.querySelector('#creacion').querySelector('a');
        if (creatorSign != null){
            creator = {
                "Sign" : creatorSign.dataset.sign,
                "UserSign" : creatorSign.dataset.usersign,
                "Message": creatorSign.textContent,
            }
        }
        return creator
    }

    function UpdateTask(){
        //Recupero los campos de la tarea
        let creator = document.querySelector('#creator').value;
        let taskID = document.querySelector('#taskID').textContent;
        let listID = document.querySelector('#listID').textContent;
        let name = document.querySelector('#taskName').value;
        let date = document.querySelector('#date').value;
        let state = document.querySelector('#state').selectedOptions[0].value
        let description = document.querySelector('#description').value;
        let check = document.querySelector('#taskCheck').textContent;
        let progress = document.getElementsByName('rangeInput')[0].value
        let usersTaskLI = document.querySelector('#usersTask').querySelectorAll('li');
        let usersTask = [];
        for (let index = 0; index < usersTaskLI.length; index++) {
            usersTask.push(usersTaskLI[index].id)
        }
        let archivos = GetFiles();
        let TaskLinks = GetLinks();
        let signsReceived = GetSignReceived();
        let signsClosed = GetSignClose();
        let signCreator = GetSignCreator();
        let newTask = {
            "ID" : taskID,
            "Name" : name,
            "Description" : description,
            "Date" : date,
            "State" : state,
            "Users" : usersTask,
            "Progress": progress,
            "Files" : archivos,
            "Links" : TaskLinks,
            "Check" : check,
            "Creator" : creator,
            "SignsReceived": signsReceived,
            "SignCreator" : signCreator,
            "SignsClose" : signsClosed,
        }
        updateTaskGO(newTask, listID).then(
            function(resultados){
                let tokenExpire = resultados[2];
                let updateStatus = resultados[1];
                let listOK = resultados[0];
                if (tokenExpire == "true"){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (listOK == "true"){
                        if (updateStatus == "Error"){
                            alert('La tarea no pudo ser actualizada')
                        }else if (updateStatus == "OK"){
                            alert('La tarea fue actualizada')
                            changeToTaskConfigGO(taskID, listID)
                        } else{
                            alert('La tarea ya fue actualizada previamente por otro usuario')
                            changeToTaskConfigGO(taskID, listID)
                        }
                    }else{
                        alert('La lista fue borrada')
                        changeHome(true)
                    }
                }
            }
        )
    }


    function DeleteTask(){
        let taskID = document.querySelector('#taskID').textContent;
        let listID = document.querySelector('#listID').textContent
        let listName = document.querySelector('#listName').textContent
        deleteTaskGO(taskID, listID).then(

            function(resultados){
                let tokenExpire = resultados[2];
                let deleteOK = resultados[1];
                let listOK = resultados[0];
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (listOK){
                        if (deleteOK == false){
                            alert('No pudo ser borrada la tarea')
                            changeToTasks(true)
                        }else{
                            alert('La tarea se borro')
                            changeToTasks(true)
                        }
                    }else{
                        alert('La lista fue borrada')
                        changeHome(true)
                    }
                }
            }
        )
    }



    function verifySignDataTask(event){
        let taskID = document.querySelector('#taskID').textContent;
        let listID = document.querySelector('#listID').textContent;
        let a = event.target.closest('li').querySelector('a')
        fileData = a.href
        linkName = a.textContent
        signUser = a.dataset.usersign
        dataType = event.target.dataset.type
        verifySignDataTaskGO(fileData, linkName, taskID, listID, signUser, dataType).then(
            function(resultados){
                if (resultados){
                    let tokenExpire = resultados[1];
                    let signOK = resultados[0];
                    if (tokenExpire){
                        alert('El Token de la sesión expiro')
                        exitSesion();
                    }else{
                        if (signOK){
                            alert('Firma verificada. Adjuntado por: ' + signUser)
                        }else{
                            alert('La firma no coincide')
                        }
                    }
                }
            }
        )
    }

    function verifySignEvent(event, type){
        let taskID = document.querySelector('#taskID').textContent;
        let a = event.target.closest('li').querySelector('a')
        data = a.textContent
        signUser = a.dataset.usersign
        verifySignEventGO(type, data, signUser).then(
            function(resultados){
                if (resultados){
                    let tokenExpire = resultados[1];
                    let signOK = resultados[0];
                    if (tokenExpire){
                        alert('El Token de la sesión expiro')
                        exitSesion();
                    }else{
                        if (signOK){
                            alert('Firma verificada')
                        }else{
                            alert('La firma no coincide')
                        }
                    }
                }
            }
        )
    }



    function addEvent(contenedor, sign, usersign, message, type){
        let ulPadre = document.querySelector(contenedor);
        let li = document.createElement('li')
        li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'lh-condensed')
        let divPadre = document.createElement('div')   
        divPadre.classList.add('container', 'row')   
        let divEvent = document.createElement('div')  
        divEvent.classList.add('col-md-11', 'order-md-1')        
        let divButton = document.createElement('div')  
        divButton.classList.add('col-md-1', 'order-md-2')  
 
        let event = document.createElement('a')
        event.dataset.sign = sign
        event.dataset.usersign = usersign
        event.textContent = message;
        divEvent.appendChild(event)

        divPadre.appendChild(divEvent)
        li.appendChild(divPadre)
        ulPadre.appendChild(li)
    }




    
    function signEventTask(event, type){
        var date = new Date();
        var fecha = date.getDate() + '-' + ( date.getMonth() + 1 ) + '-' + date.getFullYear();
        var hora = date.getHours() + ':' + ((date.getMinutes()<10?'0':'') + date.getMinutes()) + ':' + date.getSeconds();
        var fechaFull = fecha + ' ' + hora;
        let user = document.querySelector('#user').textContent
        let taskID = document.querySelector('#taskID').textContent;
        let mensaje;
        let contenedor;
        switch (type) {
            case "Creacion":
                mensaje = user + " firmo la creación de la tarea " + taskID + " el dia " + fecha + " a las " + hora;
                contenedor = "#creacion" 
                break;

            case "Recepcion":
                mensaje = user + " firmo la recepción de la tarea " + taskID + " el dia " + fecha + " a las " + hora;
                contenedor = "#recepciones"
                break;

            case "Finalizacion":
                mensaje = user + " firmo la finalización de la tarea " + taskID + " el dia " + fecha + " a las " + hora;
                contenedor = "#finalizaciones" 
                break;                        
        
            default:
                break;
        }

        signGO(mensaje).then(
            function(signHash){
                addEvent(contenedor, signHash, user, mensaje, type);
            }
        )

        event.target.remove()
    }



    function changeToTaskConfig(taskID, listID){
        changeToTaskConfigGO(taskID, listID).then(
            function(tokenExpire){
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }
            }
        )
    }


    function changeHome(exit){
        if (changes == false || exit){
                changeHomeGO().then(
                function(tokenExpire){
                    if (tokenExpire){
                        alert('El Token de la sesión expiro')
                        exitSesion();
                    }
                }
            )
        }else{
            $('#myModal2').modal('show')
        }
    }

    function init () {
        let forms = document.querySelectorAll('form');
        for (let i = 0; i < forms.length; i++) {
            forms[i].addEventListener('submit',(event) => {event.preventDefault();}, false)
        }
    }

    document.addEventListener('DOMContentLoaded',init,false);

</script>