<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tareas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">



</head>
<body>

    <nav class="navbar navbar-light bg-light">
        <form class="form-inline">
            <a class="nav-link btn-outline-secondary" type="button" role="button" onclick="changeHome()">Volver al Home</a>
            <a class="nav-link btn-outline-info" type="button" role="button" onclick="changeToAddTask()">Añadir Tareas a la lista</a>
            {{if .Tasks}}
                <a class="nav-link btn-outline-info" type="button" role="button" onclick="deleteAllTasks()">Borrar todas las Tareas</a>
            {{end}}
            
        </form>
    </nav>

    <!-- <button onclick="changeHome()">Volver al Home</button>
    <button onclick="changeToAddTask()">Añadir Tareas a la lista</button>
    {{if .Tasks}}
        <button onclick="deleteAllTasks()">Borrar todas las Tareas</button>
    {{end}} -->

    <h1 hidden id="listID">{{.ListID}}</h1>
    <h1 hidden id="listName">{{.ListName}}</h1>
        <div class="container">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2 class="display-3">Tareas de la lista: {{.ListName}}</h1>
                        <h3 class="display-4">Numero de tareas: <span class="badge bg-info">{{len .Tasks}}</span> </h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="table" data-search="true" class="table tablesorter">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Nombre</th>
                                        <th data-type="string"></i>Fecha <i class="fas fa-sort text-right"></th>
                                        <th>Estado</th>
                                        <th>Opciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .Tasks}}
                                    <tr>
                                        <td>{{.Name}}</td>
                                        <td>{{.Date}}</td>
                                        <td >
                                            {{if eq .State "En progreso"}}
                                                <div style="margin-top:5px">
                                                    <span class="badge badge-primary rounded-pill d-inline">{{.State}}</span>
                                                </div>
                                            {{end}}

                                            {{if eq .State "Hecho"}}
                                                <div style="margin-top:5px">
                                                    <span class="badge badge-success rounded-pill d-inline">{{.State}}</span>
                                                </div>
                                            {{end}}

                                            {{if eq .State "Por hacer"}}
                                                <div style="margin-top:5px">
                                                    <span class="badge badge-warning rounded-pill d-inline">{{.State}}</span>
                                                </div>
                                            {{end}}

                                        </td>
                                        <td id="{{.ID}}">
                                            <button type="button" class="btn btn-secondary" onclick="changeToTaskConfig(event)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                                    <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001z"></path>
                                                </svg>
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="DeleteTask(event)">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16">
                                                    <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- <h1>Tareas de la lista: {{.ListName}}</h1>
    <h2>Numero de tareas: {{len .Tasks}}</h2>
    {{range .Tasks}}
        <div id="{{.ID}}">
            <h2>Nombre: {{.Name}}</h2>
            <p>Description: {{.Description}}</p>
            <h3>Fecha: {{.Date}}</h3>
            <h3>{{.State}}</h3>
            <h3>Usuarios asignados: </h3>
            {{range .Users}}
                <h4>{{.}}</h4>
            {{end}}

            <div id="archivosAdjuntos">
                <h3>Archivos adjuntos:</h3>
                {{range .Files}}
                    <a href="{{.FileData}}" download="{{.FileName}}">{{.FileName}}</a>
                {{end}}
            </div>

            <button onclick="changeToTaskConfig(event)">Ver Tarea</button>
        </div>
    {{end}} -->


    <div class="modal" id="taskModal" style="display: none;" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Actualizacion Pendiente</h4>
              <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
              Hay cambios en las tareas de la lista
            </div>
            <div class="modal-footer">
                <button type="button" onclick="changeToTasks('{{.ListID}}', '{{.ListName}}')" class="btn btn-info">Actualizar</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
            </div>
            
          </div>
        </div>
      </div>

</body>
</html>

<script type="text/javascript" src="/path/to/jquery-latest.js"></script>
<script type="text/javascript" src="/path/to/jquery.tablesorter.js"></script>
<script type="text/javascript" src="/path/to/jquery.tablesorter.widgets.js"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script>
    function changeToAddTask(){
        let listID = document.querySelector('#listID').textContent
        changeToAddTaskGO(listID).then(

            function(resultados){
                let tokenExpire = resultados[1];
                let changeOK = resultados[0];
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (changeOK == false){
                        alert('La lista fue eliminada por otro usuario')
                        changeHome()
                    }
                }
            }
        )
    }


    function changeToTaskConfig(event){
        var td = event.target.closest('td');
        taskID = td.id;
        let listID = document.querySelector('#listID').textContent
        listName = document.querySelector('#listName').textContent
        changeToTaskConfigGO(taskID, listID).then(
            function(resultados){
                let tokenExpire = resultados[2];
                let changeOK = resultados[1];
                let listOK = resultados[0];
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (listOK){
                        if (changeOK == false){
                            alert('La tarea fue eliminada por otro usuario')
                            changeToTasks(listID, listName)
                        }else{
                            
                        }
                    }else{
                        alert('La lista ya no esta disponible')
                        changeHome()
                    }
                }
            }
        )
    }



    function changeToTasks(listID, listName){
        changeToTasksGO(listID,listName).then(
            function(resultados){
                let tokenExpire = resultados[1];
                let changeOK = resultados[0];
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (changeOK == false){
                        alert('La lista ya no existe')
                        changeHome()
                    }
                }
            }
        )
    }


    function DeleteTask(){
        var td = event.target.closest('td');
        taskID = td.id;
        let listID = document.querySelector('#listID').textContent
        let listName = document.querySelector('#listName').textContent
        deleteTaskGO(taskID, listID).then(

            function(resultados){
                let tokenExpire = resultados[2];
                let deleteOK = resultados[1];
                let listOK = resultados[0];
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (listOK){
                        if (deleteOK == false){
                            alert('No pudo ser borrada la tarea')
                            changeToTasks(listID, listName)
                        }else{
                            alert('La tarea se borro')
                            changeToTasks(listID, listName)
                        }
                    }else{
                        alert('La lista fue borrada')
                        changeHome()
                    }
                }
            }
        )
    }

    function deleteAllTasks(){
        let listID = document.querySelector('#listID').textContent
        let listName = document.querySelector('#listName').textContent
        deleteTaskByListGO(listID).then(
            function(resultados){
                let tokenExpire = resultados[1];
                let deleteOK = resultados[0];
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }else{
                    if (deleteOK == false){
                        alert('No se pudieron borrar las tareas')
                    }else{
                        alert('Las tarea se borraron')
                        changeToTasks(listID, listName)
                    }
                }
            }
        )
    }

    function changeHome(){
        changeHomeGO().then(
            function(tokenExpire){
                if (tokenExpire){
                    alert('El Token de la sesión expiro')
                    exitSesion();
                }
            }
        )
    }

    function checkTaskChanges(){
        let listID = document.querySelector('#listID').textContent
        checkTaskChangesGO(listID).then(
            function(result){
                if (result){
                    $('#taskModal').modal('show')
                }
            }
        )
    }






    //PRUEBAS
    function sortByDate(){ 

        // let allTR = document.querySelector('tbody').querySelectorAll('tr');

        // document.querySelector('tbody').querySelectorAll('tr')[0].querySelectorAll('td')[1].textContent


        // let fechas = ["2022-04-23", "2022-04-19", "2023-04-23", "2022-01-23"]
        // fechas.sort(function datesSorter(a, b) {
        // if (new Date(a) < new Date(b)) return -1;
        // if (new Date(a) > new Date(b)) return 1;
        // return 0;
        // })
        // console.log(fechas)

    }



    function init () {
        let forms = document.querySelectorAll('form');
        for (let i = 0; i < forms.length; i++) {
            forms[i].addEventListener('submit',(event) => {event.preventDefault();}, false)
        }

        
        setInterval('checkTaskChanges()',300000);
    }

    document.addEventListener('DOMContentLoaded',init,false);
</script>