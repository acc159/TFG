<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Home</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>


<body>
    <h1>En pruebas</h1>
    <h1 id="userEmail">{{.User.Email}}</h1>

    <button onclick="exitSesion()">Salir de la sesion</button>

    <!-- Estructura REAL -->
    <h1>Bienvenido: {{.User.Email}}</h1>
    {{$email:=.User.Email}}
    <h1>Listado de proyectos</h1>

    <div id="proyectos">
        {{if not .Datos}}
        <h1>No tienes ningun proyecto</h1>
        {{else}}
        <h1>Proyectos totales: {{len .Datos}}</h1>
            {{range .Datos}}
            <div id="{{.Proyecto.ID}}">
                <button onclick="changeToAddList(event)">Añadir Lista al proyecto</button>
                <h1>{{.Proyecto.Name}}</h1>
                <p>{{.Proyecto.Description}}</p>
                <h2>Usuarios del proyecto:</h2>
                <ul>
                    {{range .Proyecto.Users}}
                        {{if eq . $email}}
                        {{else}}
                            <li>{{.}}</li>
                        {{end}}
                    {{end}}
                </ul>
   
                <button>Actualizar Proyecto</button>
                <button class="deleteProyect" onclick="deleteProyect(event)">Eliminar Proyecto</button>
                {{if not .Listas}}
                    <h2>Ninguna Lista que mostrar</h2>
                {{else}}
                    <h2>Listas:</h2>
                    {{range .Listas}}
                    <input  name="listaID" type="hidden" value={{.ID}}>
                    <h3> {{.Name}}</h3>
                    <p>{{.Description}}</p>
                    {{end}}
                {{end}}
                <p>---------------------------------------------------------------------------</p>
            </div>
            {{end}}
        {{end}}
 
    </div>

    

    <div class="proyectos" id="proyectos">
    </div>

    <h2>Ir a añadir un proyecto</h2>
    <button onclick="changeToAddProyect()">Añadir un proyecto</button>


<!-- 
    <button onclick="llamoDesdeJavaScriptaFuncionGO()">Pulsame para ejecutar la funcion en GOLANG</button>
    <button onclick="llamarAprueba()">Traer Proyectos Usuario</button> -->
    
</body>




<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script>

    function changeToAddList(event){
        var div = event.target.closest('div');
        proyectID = div.id;

        let usersProyectElement = div.querySelectorAll('li')
        let usersProyect = []
        for (let i = 0; i < usersProyectElement.length; i++) {
            usersProyect.push(usersProyectElement[i].textContent)
        }

        changeToAddListGO(proyectID, usersProyect).then(
            function(){
                
            }
        )
    }


    function deleteProyect(event){
        var div = event.target.closest('div');
        proyectID = div.id;

        let listas = div.querySelectorAll('input[name="listaID"]')
        let listasIDs = []
        for (let i = 0; i < listas.length; i++){
            listasIDs.push(listas[i].value)
        }

        deleteProyectGO(proyectID, listasIDs).then(
            function(valorDesdeGO){
                if (valorDesdeGO == false){
                    alert('El proyecto no se borro')
                }else{
                    changeHome()
                }
            }
        )
    }


    function init(){


        //Añadimos el evento a los botones de borrado
        // let botones = document.querySelectorAll('.deleteProyect')
        // for (let i = 0; i < botones.length; i++){
        //     botones[i].addEventListener('click', )
        // }

        //getUsersToAddProyect();

        //alert("Bienvenido");
        //let boton = document.querySelector('.deleteProyect').textContent;
        //alert(boton);
    }
/*
    //Para poder mostrar por pantalla los usuarios que se pueden añadir a un proyecto
    function getUsersToAddProyect(){
        getEmailsGO().then(
            function(emails){
                let userEmail = document.querySelector('#userEmail').textContent
                for (let i = 0; i < emails.length; i++){
                    if(emails[i] != userEmail){
                        let email = document.createElement('option')
                        email.value = emails[i]
                        email.textContent = emails[i]
                        document.querySelector('#usuarios').appendChild(email)
                    }
                }
            }
        )
    }

    function addProyect(){

        //Obtengo los campos metidos por el usuario
        let proyectName = document.querySelector('#proyectName').value;
        let usuariosSeleccionados = document.querySelector('select').selectedOptions;
        if (proyectName == ""){
            alert('Introduce todos los valores para añadir un proyecto')
        }else{
            let usuariosProyect = []
            for (let index = 0; index < usuariosSeleccionados.length; index++) {
                usuariosProyect.push(usuariosSeleccionados[index].value);
                
            }

            let proyect = {
                "Name" : proyectName,
                "Users" : usuariosProyect
            }

            addProyectGO(proyect).then(
                function(valorDesdeGO){
                    if (valorDesdeGO == false){
                        alert('El proyecto no se a creado')
                    }
                }
            )
        }
    }
/*
    //Crea un div por cada proyecto que este relacionado con el usuario
    function createDivsProyects(relations){
        let proyectsIDS = [];
        //Primero creo un array con todos los ids de los proyectos , en este habran repetidos
        for (let i in relations){
            proyectsIDS.push(relations[i].ProyectID)
        }

        //Aqui limpio del array los ids repetidos
        let idsSinRepetir = proyectsIDS.filter((item, index) => {
            return proyectsIDS.indexOf(item) === index;   
        })

        //Creo un div dentro del div general de proyectos por cada proyectID
        for (let index = 0; index < idsSinRepetir.length; index++){
            var proyectos = document.querySelector('#proyectos');
            var div = document.createElement("div");
            div.id = idsSinRepetir[index];

            var titulo_lista = document.createElement('h2')
            titulo_lista.textContent = "Listas del proyecto"
            div.appendChild(titulo_lista)

            proyectos.appendChild(div)
        }
    }

    //Llamo a GO para obtener las relaciones del usuario
    function callRecibirProyectosyListasenGO(){
        recibirProyectosyListasenGO().then(
            function(relations){  

                if (relations == null) {
                        alert('No hay proyectos para el usuario')
                }else{
                    createDivsProyects(relations)
                    //Recorro cada relacion y agrego en el div correspondiente datos
                    for (let indice = 0; indice < relations.length; indice++){
                        //Obtengo el proyecto sobre el que meter la Lista
                        div = document.getElementById(relations[indice].ProyectID)
                        var tag = document.createElement("p");
                        tag.textContent = relations[indice].ListKey;
                        div.appendChild(tag);
                    }
                }
            }
        )
    }
*/


    document.addEventListener('DOMContentLoaded',init,false);
</script>